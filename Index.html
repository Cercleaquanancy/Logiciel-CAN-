<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Accueil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
    }

    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      min-height: 56px;
      background: rgba(15, 23, 42, 0.98);
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content:space-between;
      padding: 4px 16px;
      z-index: 50;
      flex-wrap: wrap;
      gap: 4px;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .navbar-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .navbar-user {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .navbar-menu {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .nav-btn {
      border: none;
      background: transparent;
      color: #cbd5f5;
      font-size: 0.8rem;
      padding: 6px 8px;
      border-radius: 999px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .nav-btn span.icon { font-size: 1rem; }

    .nav-btn.active {
      background: #1d4ed8;
      color: #e5e7eb;
    }

    .nav-btn:hover { background: #111827; }

    .navbar-logout {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 5px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .navbar-logout:hover { background: #1f2937; }

    .page {
      padding-top: 72px;
      padding-left: 12px;
      padding-right: 12px;
      padding-bottom: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .card {
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 14px 16px;
      margin-bottom: 14px;
    }

    .card h1 {
      font-size: 1.4rem;
      margin-bottom: 6px;
      color: #38bdf8;
    }

    .card h2 {
      font-size: 1.05rem;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    .card p {
      font-size: 0.85rem;
      color: #d1d5db;
    }

    .subtitle {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .small-note {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    /* Liste petits √©v√©nements sur l'accueil */
    .event-list-home {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .event-home-item {
      font-size: 0.85rem;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      background: #020617;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .event-home-main {
      flex: 1 1 auto;
      min-width: 0;
    }
    .event-home-title {
      font-weight: 600;
      color: #e5e7eb;
      margin-bottom: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-home-meta {
      font-size: 0.78rem;
      color: #9ca3af;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-home-date {
      font-size: 0.78rem;
      border-radius: 999px;
      padding: 3px 7px;
      border: 1px solid #1f2937;
      background: #111827;
      white-space: nowrap;
      color: #e5e7eb;
    }

    /* Facebook bloc */
    .fb-page-wrapper {
      margin-top: 8px;
    }

    @media (max-width: 768px) {
      .page { padding-top: 90px; }
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="navbar-left">
      <div>
        <div class="navbar-title">Espace adh√©rent</div>
        <div class="navbar-user" id="navbarUser">Non connect√©</div>
      </div>
    </div>

    <div class="navbar-menu" id="navbarMenu">
      <button class="nav-btn" data-link="index.html"><span class="icon">üè†</span> <span>Accueil</span></button>
      <button class="nav-btn" data-link="fiche.html"><span class="icon">üìÑ</span> <span>Fiche</span></button>
      <button class="nav-btn" data-link="aquarium.html"><span class="icon">üêü</span> <span>Aquarium</span></button>
      <button class="nav-btn" data-link="calcule.html"><span class="icon">üìê</span> <span>Calcule</span></button>
      <button class="nav-btn" data-link="echange.html"><span class="icon">üí¨</span> <span>√âchange</span></button>
      <button class="nav-btn" data-link="population.html"><span class="icon">üë•</span> <span>Population</span></button>
      <button class="navbar-logout" id="logoutBtn">D√©connexion</button>
    </div>
  </header>

  <main class="page">
    <div class="card">
      <h1>Accueil</h1>
      <p class="subtitle">
        R√©sum√© rapide de ton espace personnel.
      </p>
      <p>
        Cette page peut pr√©senter ton projet, ton club, les derni√®res infos.
      </p>
    </div>

    <!-- Bloc √âv√©nements (aper√ßu des plus proches) -->
    <div class="card">
      <h2>Prochains √©v√©nements</h2>
      <p class="subtitle">
        Les quelques √©v√©nements les plus proches configur√©s dans la page √âv√©nements.
      </p>

      <div id="homeEventList" class="event-list-home"></div>

      <a href="evenement.html" class="small-note" style="display:inline-block; margin-top:6px; text-decoration:none; color:#38bdf8;">
        Voir tous les √©v√©nements &gt;
      </a>
      <p class="small-note">
        Les donn√©es viennent de la m√™me liste que la page √âv√©nements gr√¢ce au stockage local du navigateur.
      </p>
    </div>

    <!-- Bloc derniers posts Facebook -->
    <div class="card">
      <h2>Derni√®res nouvelles Facebook</h2>
      <p class="subtitle">
        Derni√®res publications de la page du Cercle et de Fish In The News.
      </p>

      <!-- Derni√®re publication du Cercle Aqua Nancy -->
      <h3 style="font-size:0.95rem; margin-bottom:4px;">Cercle Aqua Nancy</h3>
      <div class="fb-page-wrapper">
        <div class="fb-page"
             data-href="https://www.facebook.com/cerclaquanancy"
             data-tabs="timeline"
             data-width="500"
             data-height=""
             data-small-header="false"
             data-adapt-container-width="true"
             data-hide-cover="false"
             data-show-facepile="true">
          <blockquote cite="https://www.facebook.com/cerclaquanancy" class="fb-xfbml-parse-ignore">
            <a href="https://www.facebook.com/cerclaquanancy">Cercle Aqua Nancy</a>
          </blockquote>
        </div>
      </div>

      <!-- Derni√®re publication de Fish In The News -->
      <h3 style="font-size:0.95rem; margin-top:10px; margin-bottom:4px;">Fish In The News</h3>
      <div class="fb-page-wrapper">
        <div class="fb-page"
             data-href="https://www.facebook.com/FishInTheNews"
             data-tabs="timeline"
             data-width="500"
             data-height=""
             data-small-header="false"
             data-adapt-container-width="true"
             data-hide-cover="false"
             data-show-facepile="true">
          <blockquote cite="https://www.facebook.com/FishInTheNews" class="fb-xfbml-parse-ignore">
            <a href="https://www.facebook.com/FishInTheNews">Fish In The News</a>
          </blockquote>
        </div>
      </div>

      <p class="small-note">
        Le plugin Page Facebook affiche automatiquement les publications r√©centes de chaque page publique.
      </p>
    </div>
  </main>

  <!-- SDK Facebook -->
  <div id="fb-root"></div>
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/fr_FR/sdk.js#xfbml=1&version=v20.0"
    nonce="CANcercle"></script>

  <script>
    // V√©rif utilisateur (login obligatoire)
    const storedUser = localStorage.getItem("user");
    if (!storedUser) { window.location.href = "login.html"; }
    let currentUser;
    try { currentUser = JSON.parse(storedUser); } catch (e) { window.location.href = "login.html"; }
    if (!currentUser || !currentUser.username) { window.location.href = "login.html"; }

    const navbarUser = document.getElementById('navbarUser');
    const roleLabel =
      currentUser.role === "admin" ? "Admin" :
      currentUser.role === "membre_bureau" ? "Membre de bureau" :
      "Adh√©rent";
    navbarUser.textContent = currentUser.username + " (" + roleLabel + ")";

    const CURRENT_PAGE = "index.html";
    const navbarMenu = document.getElementById('navbarMenu');
    const navButtons = document.querySelectorAll('.nav-btn[data-link]');

    navButtons.forEach(btn => {
      const link = btn.dataset.link;
      if (link === CURRENT_PAGE) { btn.classList.add('active'); }
      btn.addEventListener('click', () => { window.location.href = link; });
    });

    // Onglet Bureau si r√¥le OK
    if (currentUser.role === "membre_bureau" || currentUser.role === "admin") {
      const bureauBtn = document.createElement("button");
      bureauBtn.className = "nav-btn";
      bureauBtn.dataset.link = "bureau.html";
      bureauBtn.innerHTML = '<span class="icon">üèõÔ∏è</span> <span>Bureau</span>';
      const logoutBtnElem = document.getElementById("logoutBtn");
      navbarMenu.insertBefore(bureauBtn, logoutBtnElem);
      bureauBtn.addEventListener('click', () => { window.location.href = "bureau.html"; });
      if (CURRENT_PAGE === "bureau.html") { bureauBtn.classList.add('active'); }
    }

    // Onglet Serre si admin ou serre activ√©e
    if (currentUser.role === "admin" || currentUser.serre === true) {
      const serreBtn = document.createElement("button");
      serreBtn.className = "nav-btn";
      serreBtn.dataset.link = "serre.html";
      serreBtn.innerHTML = '<span class="icon">üåø</span> <span>Serre</span>';
      const logoutBtnElem2 = document.getElementById("logoutBtn");
      navbarMenu.insertBefore(serreBtn, logoutBtnElem2);
      serreBtn.addEventListener('click', () => { window.location.href = "serre.html"; });
      if (CURRENT_PAGE === "serre.html") { serreBtn.classList.add('active'); }
    }

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    });

    // --- Prochains √©v√©nements (aper√ßu) ---
    const EVENTS_KEY = "eventsData"; // m√™me cl√© que dans evenement.html

    function loadEventsForHome() {
      const raw = localStorage.getItem(EVENTS_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch(e) {
        return [];
      }
    }

    function getNextEvents(limit) {
      const all = loadEventsForHome();
      const today = new Date();
      const upcoming = all
        .filter(ev => new Date(ev.dateIso) >= today)
        .sort((a, b) => new Date(a.dateIso) - new Date(b.dateIso));
      return upcoming.slice(0, limit);
    }

    const homeEventList = document.getElementById("homeEventList");

    function renderHomeEvents() {
      if (!homeEventList) return;
      const nextEvents = getNextEvents(3); // par exemple 3 plus proches

      if (!nextEvents.length) {
        homeEventList.innerHTML = '<p class="small-note">Aucun √©v√©nement √† venir configur√© dans la page √âv√©nements.</p>';
        return;
      }

      homeEventList.innerHTML = nextEvents.map(ev => {
        const d = new Date(ev.dateIso);
        const dateStr = isNaN(d.getTime()) ? ev.dateIso : d.toLocaleDateString();
        const hourStr = ev.heure ? (" √† " + ev.heure) : "";
        return `
          <div class="event-home-item">
            <div class="event-home-main">
              <div class="event-home-title">${ev.titre}</div>
              <div class="event-home-meta">${dateStr}${hourStr} ‚Äì ${ev.lieu || ""}</div>
            </div>
            <div class="event-home-date">${dateStr}</div>
          </div>
        `;
      }).join("");
    }

    renderHomeEvents();
  </script>
</body>
</html>
